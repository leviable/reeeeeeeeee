version: 2.1

# ############################################
#
# Set Circle CI Reusable Commands
#
# For more information, see the documentation:
# https://circleci.com/docs/2.0/reusing-config
#
# ############################################
commands:
  run-python-tests:
    description: "Run Tox based Python tests"
    parameters:
      tox-env:
        type: string
    steps:
      - checkout
      - run:
          name: Install Tox
          command: sudo pip install tox
      - run:
          name: Run linter
          command: tox -e lint
      - run:
          name: Run unit tests
          command: tox -e << parameters.tox-env >>

# ###############################
#
# CircleCI 2.1 Jobs
#
# ###############################
jobs:
  tests-passed:
    description: "Gate to wait for all tests to pass"
    docker:
      - image: bash:latest
    steps:
      - run: echo "All tests passed"

  python-36-test:
    docker:
      - image: circleci/python:3.6
    steps:
      - run-python-tests:
          tox-env: "py36"

# ###############################
#
# CircleCI Job Filters
#
# ###############################
test-filters: &test-filters
  tags:
    ignore: /.*/
  branches:
    only: /.*/

deploy-filters: &deploy-filters
  tags:
    only: /.*/
  branches:
    ignore: /.*/

# ###############################
#
# CircleCI Workflow
#
# ###############################
workflows:
  version: 2.1

  reeeeeeeeee-pipeline:
    jobs:
      - python-36-test:
          filters: *test-filters
      - tests-passed:
          requires:
            - python-36-test
          filters: *test-filters
